## Экранирование вывода

### Twig

Symfony разработчики говорят так:

    Если вы используете Twig, экранирование вывода по-умолчанию активировано и вы защищены.

Каждый, кто прочтёт такое заявление будет несказанно рад, за исключением тех, кто реально озабочен безопасностью
своих приложений и кто скептически относится к подобным заявлениям. Нет такого автоматического экранирования вывода,
которое работало бы всегда и в любой ситуации. По умолчанию экранирование вывода в Symfony подразумевает, что вы
выполняете рендерниг в HTML на уровне элементов. Также Twig следует многим специальным (хотя и безопасным) правилам
автоэкранирования, о которых вам необходимо знать. Прочтите об этом в разделе 
[Документация Twig для разработчиков](http://twig.sensiolabs.org/doc/api.html#escaper-extension).

#### Контекст экранирования

Наиболее важным тут является предположение о том, что контекстом по умолчанию является html. Но это не единственный
контекст, который может быть использован в вашем приложении. Вам нужно понять, какие переменные в каком контексте
выводятся (или должны выводиться). Twig "из коробки" поддерживает следующие контексты:

- **html** - когда переменная рендерится на уровне HTML элементов,
- **html_attr** - когда переменная рендерится внутри HTML атрибутов,
- **js** - когда переменная рендерится внутри JavaScript кода,
- **css** - когда переменная рендерится внутри css стилей,
- **url** - когда рендерится часть URL (например, параметр query_string)

Когда вы определитесь с контекстом и если он отличен от HTML, вам необходимо будет воспользоваться экранирущим 
фильтром Twig (`escape`):

```twig
{{ someVariable|escape('js') }}
```

#### Экранирование вывода функций

Вы должны всегда быть на страже, когда речь идёт про авто-экранирование. Особенно, если вы создаёте ваши собственные 
Twig-функции или фильтры. Вывод ваших функций будет также автоматически экранироваться в текущем контексте
(по умолчанию - html):

```php
class MyTwigExtension extends \Twig_Extension
{
    public function getFunctions()
    {
        return array(
            \Twig_SimpleFunction('important', function($thing) {
                return sprintf(
                    '<strong>%s</strong> is important to me',
                    $thing
                );
            })
        );
    }
}
```

Результат работы этой функции будет автоэкранирован, вызов функции:

```twig
{{ important('My family') }}
```

Выведет следующее:

```html
&lt;strong&gt;My family&lt;/strong&gt; is important to me
```

Если же вы добавите опцию is_safe при определении функции в вашем расширении Twig, экранирование выполнено не будет:

```php
class MyTwigExtension extends \Twig_Extension
{
    public function getFunctions()
    {
        return array(
            \Twig_SimpleFunction('important', function($thing) {
                ...
            }, array(
                'is_safe' => array('html')
            )
        );
    }
}
```

Теперь вывод экранироваться не будет.

#### Экранирование аргументов функций

Когда мы отмечаем вывод функции как безопасный, в то же время мы включаем входные аргументы в этот же вывод и 
опять получаем небезопасную функцию:

```twig
{{ important('<script>alert("Security")</script>') }}
```

На выходе мы получим:

```twig
<strong><script>alert("Security")</script></strong> is important to me
```

Конечно же вы обычно не помещаете такой код в ваши шаблоны, но большую часть времени вы будете использовать в 
качестве аргументов Twig функций данные, предоставленные пользователями (и помните, что и вашей базе данных
большинство данных скорее всего будут результатом сохранения данных, предоставленных пользователями). И такие
данные вообще говоря могут быть всем чем угодно, если они предварительно не были должным образом очищены.

Итак, для нашего случая есть простое решение - добавить опцию pre_escape:

```php
class MyTwigExtension extends \Twig_Extension
{
    public function getFunctions()
    {
        return array(
            \Twig_SimpleFunction('important', function($thing) {
                ...
            }, array(
                'is_safe' => array('html'),
                'pre_escape' => 'html'
            )
        );
    }
}
```

Теперь все аргументы функции будут предварительно экранированы для указанного контекста.

#### Опасности raw фильтра

Вы можете полностью отменить автоэкранирование, поместив в конце выражения фильтр `raw`:

```twig
{{ message|raw }}
```

В этом случае ничего не будет экранировано, и если переменная message содержит какой-либо HTML код,
он будет отображён "как есть". Это означает, что вы должны быть на 100 процентов уверены,
что сделали всё необходимое для предотвращения инцидентов. В большинстве случаев это означает следующее:
вы должны быть уверены, что эта переменная прошла через какой-либо процесс очистки (например через очистку
с использованием HTMLPurifier, о нём было рассказано в конце предыдущей части). Или же это означает что 
источнику данных можно доверять, например если это импортированный код, написанный другим разработчиком (и
даже лучше, если это выполняется в дополнение к очистке). В то же время значение "textarea", сохраняемое
администратором не может считаться доверенным, потому что, если система безопасности вашего сайта так или
иначе будет скомпроментирована, злоумышленник может получить админ-доступ к системе, что позволит
ему внедрить вредоносный код, которые затронет множество пользователей вашего приложения. И поверьте, я не
запугиваю вас, а лишь хочу чтобы вы были осторожны.

> #### Проверка безопасности Twig
>
> Регулярно проверяйте ваши Twig-функции и фильтры на предмет использования is_safe и одновременном отсутствии  
> опции pre_escape. Также проверяйте, что все переменные, который употребляются с фильтром `raw` получаются из
> проверенных источников.
